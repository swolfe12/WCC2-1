name: Deploy WCC Site to IONOS

on:
  push:
    branches: ["main", "staging"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # If you add a build step later, it goes here (e.g., npm install + build)

      - name: Choose target directory
        id: vars
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "remote_dir=${{ secrets.SFTP_REMOTE_DIR_PROD }}" >> $GITHUB_OUTPUT
          else
            echo "remote_dir=${{ secrets.SFTP_REMOTE_DIR_STAGING }}" >> $GITHUB_OUTPUT
          fi

      - name: Deploy via SFTP (lftp)
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

          REMOTE_DIR="${{ steps.vars.outputs.remote_dir }}"

          lftp -u "${{ secrets.SFTP_USER }},${{ secrets.SFTP_PASS }}" sftp://${{ secrets.SFTP_HOST }}:${{ secrets.SFTP_PORT }} <<EOF
          set sftp:auto-confirm yes
          set net:max-retries 2
          set net:timeout 30
          set xfer:clobber on
          mkdir -p "$REMOTE_DIR"
          mirror -R --delete --verbose public/ "$REMOTE_DIR"
          bye
          EOF
